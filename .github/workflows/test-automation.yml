name: 🚀 Test Automation Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Daily runs at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      browser:
        description: 'Browser for Testing'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      test_suite:
        description: 'Test Suite to Run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - all

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx2048m -XX:MaxPermSize=512m'
  ALLURE_VERSION: '2.24.0'

jobs:
  # ===============================
  # 🔍 Code Quality Check
  # ===============================
  code-quality:
    name: 🔍 Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 📦 Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 🔨 Compile Project
        run: mvn clean compile -DskipTests

      - name: ✅ Run Static Analysis
        run: mvn checkstyle:check || true

  # ===============================
  # 🧪 E2E Tests Matrix
  # ===============================
  e2e-tests:
    name: 🧪 E2E Tests
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox]
        include:
          - browser: chrome
            driver_options: "--headless --no-sandbox --disable-dev-shm-usage --disable-gpu"
          - browser: firefox
            driver_options: "--headless"

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 📦 Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 🔧 Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb

      - name: 🌐 Setup Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@latest

      - name: 🦊 Setup Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@latest

      - name: 📋 Display Environment Info
        run: |
          echo "🔧 Java Version: $(java -version)"
          echo "📦 Maven Version: $(mvn -version)"
          echo "🌐 Browser: ${{ matrix.browser }}"
          echo "⚙️ Driver Options: ${{ matrix.driver_options }}"

      - name: 🧪 Run Tests
        run: |
          mvn clean test \
            -Dbrowser=${{ matrix.browser }} \
            -Dheadless=true \
            -Dtest.environment=${{ github.event.inputs.test_environment || 'staging' }} \
            -Dtest.suite=${{ github.event.inputs.test_suite || 'smoke' }}
        env:
          DISPLAY: :99

      - name: 📊 Generate Allure Report
        if: always()
        run: |
          mvn allure:report
          echo "📈 Allure report generated at: target/site/allure-maven-plugin"

      - name: 📸 Capture Screenshots on Failure
        if: failure()
        run: |
          mkdir -p screenshots
          find . -name "*.png" -path "*/test-output/*" -exec cp {} screenshots/ \; || true
          ls -la screenshots/ || echo "No screenshots found"

      - name: 📤 Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            target/surefire-reports/
            allure-results/
            target/site/allure-maven-plugin/
            screenshots/
          retention-days: 30

      - name: 📤 Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results/
          retention-days: 30

  # ===============================
  # 📊 Allure Report Publishing
  # ===============================
  publish-report:
    name: 📊 Publish Allure Report
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 📥 Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          merge-multiple: true
          path: allure-results/

      - name: 📊 Generate Combined Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history

      - name: 🚀 Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-history
          destination_dir: allure-report

      - name: 📝 Add Report Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const reportUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `📊 **Allure Test Report**: [View Report](${reportUrl})`
            });

  # ===============================
  # 🐳 Docker Integration Test
  # ===============================
  docker-test:
    name: 🐳 Docker Integration Test
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔧 Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: 🚀 Run Tests in Docker
        run: |
          chmod +x run-tests-docker.sh
          ./run-tests-docker.sh
        timeout-minutes: 15

      - name: 📤 Upload Docker Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-results
          path: |
            allure-results/
            target/surefire-reports/
          retention-days: 30

      - name: 🧹 Cleanup Docker
        if: always()
        run: |
          docker-compose down -v --remove-orphans || true
          docker system prune -f || true

  # ===============================
  # 📬 Notification
  # ===============================
  notify:
    name: 📬 Send Notifications
    runs-on: ubuntu-latest
    needs: [e2e-tests, publish-report, docker-test]
    if: always()
    
    steps:
      - name: 📊 Evaluate Test Results
        id: results
        run: |
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          DOCKER_STATUS="${{ needs.docker-test.result }}"
          PUBLISH_STATUS="${{ needs.publish-report.result }}"
          
          if [[ "$E2E_STATUS" == "success" && "$DOCKER_STATUS" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=✅ All tests passed successfully!" >> $GITHUB_OUTPUT
          elif [[ "$E2E_STATUS" == "failure" || "$DOCKER_STATUS" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=❌ Some tests failed. Check the reports for details." >> $GITHUB_OUTPUT
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message=⚠️ Tests completed with warnings." >> $GITHUB_OUTPUT
          fi

      - name: 📬 Create Summary
        if: always()
        run: |
          echo "## 🧪 Test Automation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Tests | ${{ needs.docker-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Report Publishing | ${{ needs.publish-report.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Message**: ${{ steps.results.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📊 **Live Report**: [View Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report)" >> $GITHUB_STEP_SUMMARY 